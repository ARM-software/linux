// SPDX-License-Identifier: GPL-2.0
/*
 * (C) COPYRIGHT 2018-2019 ARM Limited. All rights reserved.
 * Author: luffy.yuan <luffy.yuan@arm.com>
 *
 */
#include <linux/kernel.h>
#include "ad3_assertive_lut.h"

#define LOG2_BL_LUT_NUM		5
#define BL_LUT_RIGHT_SHIFT	(BL_DATA_WIDH - LOG2_BL_LUT_NUM)
#define POW2_BL_LUT_RS		(2 << BL_LUT_RIGHT_SHIFT)

const uint32_t assertive_lut[] = {
	253, /* 0.0618241 */
	258, /* 0.0631833 */
	264, /* 0.0645723 */
	270, /* 0.0659918 */
	276, /* 0.0674426 */
	282, /* 0.0689253 */
	288, /* 0.0704405 */
	294, /* 0.0719891 */
	301, /* 0.0735717 */
	307, /* 0.0751891 */
	314, /* 0.076842 */
	321, /* 0.0785313 */
	328, /* 0.0802577 */
	335, /* 0.0820221 */
	343, /* 0.0838253 */
	350, /* 0.0856681 */
	358, /* 0.0875514 */
	366, /* 0.0894762 */
	374, /* 0.0914432 */
	382, /* 0.0934535 */
	391, /* 0.095508 */
	399, /* 0.0976076 */
	408, /* 0.0997534 */
	417, /* 0.101946 */
	426, /* 0.104188 */
	436, /* 0.106478 */
	445, /* 0.108819 */
	455, /* 0.111211 */
	465, /* 0.113656 */
	475, /* 0.116155 */
	486, /* 0.118708 */
	496, /* 0.121318 */
	507, /* 0.123985 */
	519, /* 0.12671 */
	530, /* 0.129496 */
	542, /* 0.132343 */
	553, /* 0.135252 */
	566, /* 0.138226 */
	578, /* 0.141264 */
	591, /* 0.14437 */
	604, /* 0.147544 */
	617, /* 0.150787 */
	631, /* 0.154102 */
	645, /* 0.15749 */
	659, /* 0.160952 */
	673, /* 0.164491 */
	688, /* 0.168107 */
	703, /* 0.171803 */
	719, /* 0.175579 */
	734, /* 0.179439 */
	751, /* 0.183384 */
	767, /* 0.187416 */
	784, /* 0.191536 */
	801, /* 0.195747 */
	819, /* 0.20005 */
	837, /* 0.204448 */
	855, /* 0.208942 */
	874, /* 0.213536 */
	893, /* 0.21823 */
	913, /* 0.223028 */
	933, /* 0.227931 */
	954, /* 0.232941 */
	975, /* 0.238062 */
	996, /* 0.243296 */
	1018, /* 0.248645 */
	1040, /* 0.254111 */
	1063, /* 0.259697 */
	1087, /* 0.265406 */
	1111, /* 0.271241 */
	1135, /* 0.277204 */
	1160, /* 0.283298 */
	1185, /* 0.289526 */
	1211, /* 0.295891 */
	1238, /* 0.302396 */
	1265, /* 0.309044 */
	1293, /* 0.315838 */
	1322, /* 0.322781 */
	1351, /* 0.329877 */
	1380, /* 0.337129 */
	1411, /* 0.34454 */
	1442, /* 0.352115 */
	1473, /* 0.359856 */
	1506, /* 0.367767 */
	1539, /* 0.375852 */
	1573, /* 0.384114 */
	1607, /* 0.392559 */
	1643, /* 0.401189 */
	1679, /* 0.410008 */
	1716, /* 0.419022 */
	1754, /* 0.428234 */
	1792, /* 0.437648 */
	1832, /* 0.447269 */
	1872, /* 0.457102 */
	1913, /* 0.467151 */
	1955, /* 0.477421 */
	1998, /* 0.487916 */
	2042, /* 0.498643 */
	2087, /* 0.509605 */
	2133, /* 0.520808 */
	2180, /* 0.532257 */
	2228, /* 0.543959 */
	2277, /* 0.555917 */
	2327, /* 0.568138 */
	2378, /* 0.580628 */
	2430, /* 0.593393 */
	2483, /* 0.606438 */
	2538, /* 0.61977 */
	2594, /* 0.633395 */
	2651, /* 0.647319 */
	2709, /* 0.66155 */
	2769, /* 0.676093 */
	2830, /* 0.690956 */
	2892, /* 0.706146 */
	2955, /* 0.72167 */
	3020, /* 0.737535 */
	3087, /* 0.753749 */
	3155, /* 0.77032 */
	3224, /* 0.787254 */
	3295, /* 0.804561 */
	3367, /* 0.822249 */
	3441, /* 0.840325 */
	3517, /* 0.858799 */
	3594, /* 0.877679 */
	3674, /* 0.896973 */
	3754, /* 0.916693 */
	3837, /* 0.936845 */
	3921, /* 0.957441 */
	4007, /* 0.978489 */
	4096, /* 1 */
	4186, /* 1.02198 */
	4278, /* 1.04445 */
	4372, /* 1.06741 */
	4468, /* 1.09088 */
	4566, /* 1.11486 */
	4666, /* 1.13937 */
	4769, /* 1.16442 */
	4874, /* 1.19002 */
	4981, /* 1.21618 */
	5090, /* 1.24291 */
	5202, /* 1.27024 */
	5317, /* 1.29816 */
	5434, /* 1.3267 */
	5553, /* 1.35587 */
	5675, /* 1.38567 */
	5800, /* 1.41614 */
	5928, /* 1.44727 */
	6058, /* 1.47909 */
	6191, /* 1.5116 */
	6327, /* 1.54483 */
	6466, /* 1.57879 */
	6608, /* 1.6135 */
	6754, /* 1.64897 */
	6902, /* 1.68522 */
	7054, /* 1.72227 */
	7209, /* 1.76014 */
	7368, /* 1.79883 */
	7529, /* 1.83838 */
	7695, /* 1.87879 */
	7864, /* 1.92009 */
	8037, /* 1.9623 */
	8214, /* 2.00544 */
	8394, /* 2.04953 */
	8579, /* 2.09459 */
	8768, /* 2.14064 */
	8960, /* 2.1877 */
	9157, /* 2.23579 */
	9359, /* 2.28494 */
	9564, /* 2.33517 */
	9775, /* 2.38651 */
	9990, /* 2.43897 */
	10209, /* 2.49259 */
	10434, /* 2.54739 */
	10663, /* 2.60339 */
	10897, /* 2.66062 */
	11137, /* 2.71912 */
	11382, /* 2.77889 */
	11632, /* 2.83998 */
	11888, /* 2.90242 */
	12149, /* 2.96622 */
	12416, /* 3.03143 */
	12689, /* 3.09808 */
	12968, /* 3.16618 */
	13253, /* 3.23579 */
	13545, /* 3.30692 */
	13842, /* 3.37962 */
	14147, /* 3.45392 */
	14458, /* 3.52985 */
	14776, /* 3.60745 */
	15100, /* 3.68676 */
	15432, /* 3.76781 */
	15772, /* 3.85064 */
	16118, /* 3.93529 */
	16473, /* 4.02181 */
	16835, /* 4.11022 */
	17205, /* 4.20058 */
	17583, /* 4.29292 */
	17970, /* 4.3873 */
	18365, /* 4.48375 */
	18769, /* 4.58232 */
	19181, /* 4.68306 */
	19603, /* 4.78601 */
	20034, /* 4.89123 */
	20474, /* 4.99875 */
	20925, /* 5.10865 */
	21385, /* 5.22096 */
	21855, /* 5.33573 */
	22335, /* 5.45303 */
	22826, /* 5.57291 */
	23328, /* 5.69543 */
	23841, /* 5.82063 */
	24365, /* 5.9486 */
	24901, /* 6.07937 */
	25448, /* 6.21302 */
	26007, /* 6.3496 */
	26579, /* 6.48919 */
	27164, /* 6.63185 */
	27761, /* 6.77765 */
	28371, /* 6.92665 */
	28995, /* 7.07892 */
	29632, /* 7.23454 */
	30284, /* 7.39359 */
	30949, /* 7.55613 */
	31630, /* 7.72224 */
	32325, /* 7.89201 */
	33036, /* 8.0655 */
	33762, /* 8.24282 */
	34504, /* 8.42403 */
	35263, /* 8.60922 */
	36038, /* 8.79848 */
	36830, /* 8.99191 */
	37640, /* 9.18959 */
	38468, /* 9.39161 */
	39313, /* 9.59808 */
	40177, /* 9.80908 */
	41061, /* 10.0247 */
	41963, /* 10.2451 */
	42886, /* 10.4703 */
	43829, /* 10.7005 */
	44792, /* 10.9358 */
	45777, /* 11.1762 */
	46783, /* 11.4219 */
	47812, /* 11.673 */
	48863, /* 11.9296 */
	49937, /* 12.1918 */
	51035, /* 12.4599 */
	52157, /* 12.7338 */
	53304, /* 13.0137 */
	54476, /* 13.2998 */
	55673, /* 13.5922 */
	56897, /* 13.891 */
	58148, /* 14.1964 */
	59426, /* 14.5085 */
	60733, /* 14.8274 */
	62068, /* 15.1534 */
	63432, /* 15.4865 */
	64827, /* 15.827 */
};

int ad3_assertive_bl_lut(int input, u16 *lut_nodes)
{
	int index, diff, node0, node1, node_mul, sign = -1;

	index = input >> BL_LUT_RIGHT_SHIFT;
	node0 = (int)lut_nodes[index];
	node1 = (int)lut_nodes[index+1];

	diff = node1 - node0;
	if (diff < 0) {
		sign = 1;
		diff = -diff;
	}

	node_mul = input & (POW2_BL_LUT_RS - 1);

	return (node0 - sign * ((node_mul * diff) >> BL_LUT_RIGHT_SHIFT));
}

int ad3_assertive_calc_bl_input(u16 *bl_lin_lut,
				u16 *bl_att_lut,
				int alpha, int num_bl_bits,
				int bl_input)
{
	int bl_lineared, bl_attenuated;
	int bl_atten_minus_bl_lin, mult_o, sign = 1;
	/* Scale the backlight into 16bits*/
	int bl_scaled = bl_input * (1 << (BL_DATA_WIDH - num_bl_bits));

	/*Calculate linearized BL*/
	bl_lineared = ad3_assertive_bl_lut(bl_scaled, bl_lin_lut);
	/*Calculate the attenuated BL*/
	bl_attenuated = ad3_assertive_bl_lut(bl_lineared, bl_att_lut);

	bl_atten_minus_bl_lin = bl_attenuated - bl_lineared;
	if (bl_atten_minus_bl_lin < 0) {
		bl_atten_minus_bl_lin = -bl_atten_minus_bl_lin;
		sign = -1;
	}

	mult_o = (bl_atten_minus_bl_lin * alpha) >> 8;

	return (bl_lineared + sign * mult_o);
}
